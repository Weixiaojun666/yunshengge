<title>娱乐项目</title>

<div class="layui-card layadmin-header">
    <div class="layui-breadcrumb" lay-filter="breadcrumb">
        <a lay-href="">主页</a>
        <a><cite>前台销售</cite></a>
    </div>
</div>

<div class="layui-fluid">
    <div class="layui-row layui-col-space10">
        <div class="layui-col-md9">
            <div class="layui-card">
                <div class="layui-card-header">新订单</div>
                <div class="layui-card-body" style="padding: 15px;">
                    <form action="" class="layui-form" id="form1" name="form1">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">条码:</label>
                                <div class="layui-input-inline">
                                    <input autocomplete="off" class="layui-input" lay-verify="title" name="barcode"
                                           type="text">
                                </div>
                                <button class="layui-btn layui-btn-primary" lay-filter="addNews" lay-submit>提交
                                </button>

                                <!-- <button type="reset" class="layui-btn layui-btn-primary">挂单</button> -->

                                <button class="layui-btn layui-btn-primary" onclick="layui.table.reload('table1');"
                                        type="reset">刷新
                                </button>

                                <button class="layui-btn layui-btn-primary" onclick="salesreset();"
                                        type="reset">重置
                                </button>
                                <button class="layui-btn layui-btn-primary" data-type="pay"
                                        type="reset">结算
                                </button>

                            </div>
                        </div>
                    </form>
                    <table class="layui-hide" id="table1" lay-filter="table1"></table>
                </div>
            </div>
            <div class="layui-card">
                <div class="layui-card-header">近期场次</div>
                <div class="layui-card-body">
                    <div class="layui-btn-container">
                        <form action="" class="layui-form">

                        </form>
                    </div>
                    <script id="bar2" type="text/html">
                        {{# if(d.znumber == d.paid){ }}
                        <a class="layui-btn layui-btn-xs layui-btn-disabled" lay-event="edit">支付</a>
                        {{# } else { }}
                        <a class="layui-btn layui-btn-xs" lay-event="edit">支付</a>
                        {{# } }}

                        {{# if(d.state == '待开始'){ }}
                        <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="edit">开始</a>
                        {{# } }}
                        {{# if(d.state == '已开始'){ }}
                        <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="edit">结束</a>
                        {{# } }}
                        {{# if(d.state == '已结束'){ }}
                        <a class="layui-btn layui-btn-xs layui-btn-danger"
                           lay-event="edit">作废</a>
                        {{# } }}

                    </script>
                    <table class="layui-hide" id="table2"></table>
                </div>
            </div>
            <div class="layui-card">
                <div class="layui-card-header">近期订单</div>
                <div class="layui-card-body">
                    <div class="layui-btn-container">
                        <form action="" class="layui-form">
                        </form>
                    </div>

                    <script id="bar" type="text/html">
                        <a class="layui-btn layui-btn-xs" lay-event="edit">详情</a>


                        {{# if(d.state == '已支付'){ }}
                        <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="edit">退款</a>
                        {{# } }}
                        {{# if(d.state == '待支付'){ }}
                        <a class="layui-btn layui-btn-xs layui-btn-danger"
                           lay-event="edit">支付</a>
                        {{# } }}
                        {{# if(d.state == '待退款'){ }}
                        <a class="layui-btn layui-btn-xs layui-btn-disabled" lay-event="edit">确认</a>
                        {{# } }}
                        {{# if(d.state == '已取消'){ }}
                        <a class="layui-btn layui-btn-xs layui-btn-disabled" lay-event="edit">删除</a>
                        {{# } }}


                    </script>
                    <table class="layui-hide" id="table3"></table>
                </div>
            </div>
        </div>

        <div class="layui-col-md3">

            <div class="layui-card">
                <div class="layui-card-header">今日数据</div>
                <div class="layui-card-body" style="padding: 15px;">
                    <ul class="layui-row layui-col-space10">
                        <li class="layui-col-xs6">
                            <div class="layadmin-backlog-body">
                                <h3>开场数</h3>
                                <p><cite>3</cite></p>
                            </div>
                        </li>
                        <li class="layui-col-xs6">
                            <div class="layadmin-backlog-body">
                                <h3>收款数</h3>
                                <p><cite>21</cite></p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="layui-card">
                <div class="layui-card-header">会员</div>
                <div class="layui-card-body" style="padding: 15px;">
                    <form action="" class="layui-form" id="form2">
                        <div class="layui-form-item">
                            <label class="layui-form-label">会员卡号：</label>
                            <div class="layui-input-block">
                                <input class="layui-input" lay-verify="required" name="membercard" placeholder=""
                                       type="text">
                            </div>
                        </div>
                        <label class="layui-form-label">名称:</label>
                        <div class="layui-input-block">
                            <input autocomplete="off" class="layui-input layui-disabled" disabled id="membername"
                                   lay-verify="title" type="text" value="">
                        </div>
                        <label class="layui-form-label">等级:</label>
                        <div class="layui-input-block">
                            <input autocomplete="off" class="layui-input layui-disabled" disabled id="grade"
                                   lay-verify="title" type="text" value="">
                        </div>
                        <label class="layui-form-label">余额:</label>
                        <div class="layui-input-block">
                            <input autocomplete="off" class="layui-input layui-disabled" disabled id="vbalance"
                                   lay-verify="title" type="text" value="">
                        </div>
                        <label class="layui-form-label">积分:</label>
                        <div class="layui-input-block">
                            <input autocomplete="off" class="layui-input layui-disabled" disabled id="integral"
                                   lay-verify="title" type="text" value="">
                        </div>
                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <button class="layui-btn layui-btn-primary" lay-filter="Member" lay-submit>提交</button>
                                <button class="layui-btn layui-btn-primary" type="reset">重置</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="layui-card">
                <div class="layui-card-header">场次</div>
                <div class="layui-card-body" style="padding: 15px;">

                    <form action="" class="layui-form" id="form3">

                        <div class="layui-form-item">
                            <label class="layui-form-label">剧本条码：</label>
                            <div class="layui-input-block">
                                <input autocomplete="off" class="layui-input" lay-verify="required" name="gameid"
                                       placeholder=""
                                       type="text">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">主持人ID：</label>
                            <div class="layui-input-block">
                                <input autocomplete="off" class="layui-input" lay-verify="required" name="sell"
                                       placeholder=""
                                       type="text">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">总人数：</label>
                            <div class="layui-input-block">
                                <input autocomplete="off" class="layui-input" lay-verify="required" name="number"
                                       placeholder=""
                                       type="text">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <button class="layui-btn layui-btn-primary" lay-filter="Game" lay-submit>新建</button>
                                <button class="layui-btn layui-btn-primary" type="reset">重置</button>
                            </div>
                        </div>
                    </form>

                </div>
            </div>
            <!-- 			<div class="layui-card">
                <div class="layui-card-header">剧本</div>
                <div class="layui-card-body" style="padding: 15px;">
                    <form class="layui-form" action="" id="form3">
                        <div class="layui-form-item">
                            <label class="layui-form-label">剧本ID：</label>
                            <div class="layui-input-block">
                                <input type="text" name="membercard" lay-verify="required" placeholder=""
                                 class="layui-input">
                            </div>
                        </div>
                        <label class="layui-form-label">名称:</label>
                        <div class="layui-input-block">
                            <input type="text" name="gamename" lay-verify="title" autocomplete="off" disabled
                                class="layui-input layui-disabled" value="" id="name">
                        </div>
                        <label class="layui-form-label">状态:</label>
                        <div class="layui-input-block">
                            <input type="text" name="grade" lay-verify="title" autocomplete="off" disabled
                                class="layui-input layui-disabled" value="" id="grade">
                        </div>
                        <label class="layui-form-label">人数:</label>
                        <div class="layui-input-block">
                            <input type="text" name="balance" lay-verify="title" autocomplete="off" disabled
                                class="layui-input layui-disabled" value="" id="vbalance">
                        </div>
                        <label class="layui-form-label">售价:</label>
                        <div class="layui-input-block">
                            <input type="text" name="balance" lay-verify="title" autocomplete="off" disabled
                                class="layui-input layui-disabled" value="" id="integral">
                        </div>
                        <label class="layui-form-label">类型:</label>
                        <div class="layui-input-block">
                            <input type="text" name="balance" lay-verify="title" autocomplete="off" disabled
                                class="layui-input layui-disabled" value="" id="integral">
                        </div>
                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <button class="layui-btn layui-btn-primary" lay-submit lay-filter="Game">提交</button>
                                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div> -->
        </div>
    </div>
</div>
<script>
    var HttpClient = function () {
        this.get = function (aUrl, aCallback) {
            var anHttpRequest = new XMLHttpRequest();
            anHttpRequest.onreadystatechange = function () {
                if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                    aCallback(anHttpRequest.responseText);
            }
            anHttpRequest.open("GET", aUrl, true);
            anHttpRequest.send(null);
        }
    }

    //重置
    function salesreset() {
        var client = new HttpClient();
        client.get('./api/ordertmp_u?' + '&token=' + layui.data('yushengge').token,
            function (response) {
                //回传操作
                layui.table.reload('table1');
            });
    }

    layui.use(['admin', 'form', 'laydate', 'slider'], function () {
        var $ = layui.$,
            admin = layui.admin,
            element = layui.element,
            layer = layui.layer,
            laydate = layui.laydate,
            form = layui.form;
        var table = layui.table;
        var slider = layui.slider;
        var util = layui.util;
        var view = layui.view;


        var active = {
            pay: function () {
                admin.req({
                    url: './api/ordersinfo',
                    type: 'get',
                    dataType: 'json',
                    data: null,
                    success: function (result) {
                        var end = JSON.parse(result);
                        layui.table.reload('table1');
                        if (end.code === 0) {
                            admin.popup({
                                title: '支付',
                                area: ['700px', '400px'],
                                id: 'LAY-popup-user-add',
                                success: function (layero, index) {
                                    view(this.id).render('pay/payform', {
                                        'orderid': end.orderid,
                                        'creation': end.creation,
                                        'amount': end.amount,
                                        'vamount': end.vamount
                                    }).done(function () {
                                        form.render(null, 'layuiadmin-form-useradmin');
                                        //开启提交
                                        form.on('submit(LAY-user-front-submit)', function (data) {
                                            var field = data.field; //获取提交的字段											//提交 Ajax 成功后，关闭当前弹层并重载表格
                                            admin.req({
                                                url: './api/orders',
                                                type: 'get',
                                                dataType: 'json',
                                                data: field,
                                                success: function (result) {
                                                    var end = JSON.parse(result);
                                                    layer.msg(end.msg);
                                                    layer.close(index); //执行关闭
                                                }
                                            });
                                        });
                                    });
                                }
                            });
                        } else {
                            layer.msg(end.msg, {icon: 5});
                        }

                    }
                });
            },
        };
        // admin.req({
        // 	url: './api/pay',
        // 	type: 'get',
        // 	dataType: 'json',
        // 	data: field,
        // 	success: function(result) {

        // 		view(this.id).render('pay/payform',result.data).done(function () {
        // 			form.render(null, 'layuiadmin-form-useradmin');

        // 			//开启提交
        // 			form.on('submit(LAY-user-front-submit)', function (data) {
        // 				var field = data.field; //获取提交的字段

        // 				//提交 Ajax 成功后，关闭当前弹层并重载表格
        // 				admin.req({
        // 					url: './api/useradminuserlist_i',
        // 					type: 'get',
        // 					dataType: 'json',
        // 					data: field,
        // 					success: function (result) {

        // 						layer.close(
        // 							index); //执行关闭
        // 					}
        // 				});
        // 			});
        // 		});
        // 	}
        // });


        $('.layui-btn').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });

        //收银台
        form.on('submit(addNews)', function (data) {
            var field = data.field;
            admin.req({
                url: './api/ordertmp_i',
                type: 'get',
                dataType: 'json',
                data: field,
                success: function (result) {
                    table.reload('table1');
                    $("#form1")[0].reset();
                    layui.form.render();
                }
            });

            return false;
        });
        //会员信息
        form.on('submit(Member)', function (data) {

            var field = data.field;
            return false;
        });

        //场次信息
        form.on('submit(Game)', function (data) {

            var field = data.field;

            admin.req({
                url: './api/game',
                type: 'get',
                dataType: 'json',
                data: field,
                success: function (result) {
                    table.reload('table2');
                    $("#form3")[0].reset();
                    layui.form.render();
                }
            });
            return false;
        });

        table.render({
            elem: '#table1',
            url: './api/ordertmp_s',
            totalRow: true,
            cols: [
                [{
                    field: 'barcode',
                    title: '商品条码',
                    totalRowText: '合计'
                }, {
                    field: 'name',
                    title: '名称'
                }, {
                    field: 'price',
                    title: '单价'
                }, {
                    field: 'member',
                    title: '会员价',
                },
                    {
                        field: 'quantity',
                        title: '数量',
                        edit: 'text',
                        totalRow: true
                    }, {
                    field: 'ptotal',
                    title: '小计',
                    totalRow: true
                },
                    {
                        field: 'vtotal',
                        title: '会员小计',
                        totalRow: true
                    }
                ]
            ]
        });
        //数量更新
        table.on('edit(table1)', function (obj) {
            var value = obj.value //得到修改后的值
                ,
                data = obj.data //得到所在行所有键值
                ,
                field = obj.field; //得到字段
            var client = new HttpClient();
            client.get('./api/ordertmp_u' + '&quantity=' + util.escape(value) + '&barcode=' + data
                .barcode + '&token=' + layui.data('yushengge').token,
                function (response) {
                    table.reload('table1');
                });
        });

        table.render({
            elem: '#table2',
            url: './api/scenelist_s',
            cols: [
                [{
                    field: 'sid',
                    title: '场次id'
                }, {
                    field: 'name',
                    title: '名称'
                }, {
                    field: 'nickname',
                    title: '主持'
                }, {
                    field: 'znumber',
                    title: '人数'
                }, {
                    field: 'paid',
                    title: '已付'
                }, {
                    field: 'create',
                    title: '时间'
                }, {
                    field: 'state',
                    title: '状态'
                }, {
                    fixed: 'right',
                    title: '操作',
                    toolbar: '#bar2',
                    width: 150
                }]
            ]
        });
        table.render({
            elem: '#table3',
            url: './api/pointslist_s',
            cols: [
                [{
                    field: 'orderid',
                    title: '订单号'
                }, {
                    field: 'amount',
                    title: '金额'
                }, {
                    field: 'create',
                    title: '创建时间'
                }, {
                    field: 'end',
                    title: '支付时间'
                }, {
                    field: 'type',
                    title: '渠道'
                }, {
                    field: 'online',
                    title: '交易号'
                }, {
                    field: 'name',
                    title: '会员'
                }, {
                    field: 'introducer',
                    title: '介绍人'
                }, {
                    field: 'state',
                    title: '状态'
                }, {
                    fixed: 'right',
                    title: '操作',
                    toolbar: '#bar',
                    width: 150
                }]
            ]
        });
    });
</script>